<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Product List</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Product List</h1>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>

    <div class="mb-3">
        <button id="showExpiredBtn" class="btn btn-warning me-2">Show Expired Products</button>
        <button id="resetBtn" class="btn btn-secondary me-2">Reset</button>
        <button id="addProductBtn" class="btn btn-primary">Add Product</button>
        <button id="showReportBtn" class="btn btn-info">Show Report</button>
    </div>

    <table id="productTable" class="table table-striped table-bordered" style="width:100%">
        <thead class="table-dark">
        <tr>
            <th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Discount</th>
            <th>Discounted Price</th><th>Quantity</th><th>Expiry Date</th><th>Available</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Add Product Form -->
    <div id="addProductFormContainer" class="card p-4 mb-4" style="display:none;">
        <h4>Add New Product</h4>
        <form id="addProductForm">
            <div class="mb-3">
                <label for="productId" class="form-label">Product ID</label>
                <input type="text" id="productId" name="id" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="productName" class="form-label">Name</label>
                <input type="text" id="productName" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="productCategory" class="form-label">Category</label>
                <select id="productCategory" name="category" class="form-select" required>
                    <option value="">Select Category</option>
                    <option value="Beauty Care">Beauty Care</option>
                    <option value="Vegetables">Vegetables</option>
                    <option value="Meat">Meat</option>
                    <option value="Groceries">Groceries</option>
                    <option value="Others">Others</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="productPrice" class="form-label">Price</label>
                <input type="number" step="0.01" id="productPrice" name="price" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="productDiscount" class="form-label">Discount (%)</label>
                <input type="number" step="1" id="productDiscount" name="discount" class="form-control" value="0" min="0" max="100">
            </div>
            <div class="mb-3">
                <label for="productQuantity" class="form-label">Quantity</label>
                <input type="number" id="productQuantity" name="quantity" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="productExpiry" class="form-label">Expiry Date</label>
                <input type="date" id="productExpiry" name="expiryDate" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Submit</button>
            <button type="button" id="cancelAddProduct" class="btn btn-secondary ms-2">Cancel</button>
        </form>
    </div>

    <!-- Reports -->
    <div id="reportContainer" style="display:none; margin-top: 30px;">
        <h3>Reports</h3>

        <h5>Total Price by Category</h5>
        <ul id="totalValueByCategory" class="list-group mb-4"></ul>

        <h5>Products by Category with Discounts</h5>
        <div id="productsByCategory"></div>
    </div>
</div>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    const baseUrl = 'http://localhost:8080/api/products';
    const token = localStorage.getItem("raino_jwt_token");

    if (!token) {
        window.location.href = "index.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("raino_jwt_token");
        window.location.href = "index.html";
    });

    let productTable;
    initProductTable();

    function initProductTable() {
        productTable = $('#productTable').DataTable();
        loadProducts(baseUrl);

        document.getElementById("showExpiredBtn").addEventListener("click", () => {
            loadProducts(`${baseUrl}/expiring`);
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
            document.getElementById("reportContainer").style.display = "none";
            document.getElementById("addProductFormContainer").style.display = "none";
            loadProducts(baseUrl);
        });
    }

    async function fetchWithToken(url, options = {}) {
        options.headers = options.headers || {};
        options.headers["Authorization"] = "Bearer " + token;
        const res = await fetch(url, options);
        if (!res.ok) throw new Error("Fetch failed");
        return res.json();
    }

    async function loadProducts(url) {
        clearTable();
        try {
            const products = await fetchWithToken(url);
            populateTable(products);
        } catch (e) {
            alert("Could not load products.");
            console.error(e);
        }
    }

    function populateTable(products) {
        products.forEach(product => {
            productTable.row.add([
                product.id,
                product.name,
                product.category,
                product.price.toFixed(2),
                product.discount + "%",
                product.discountedPrice.toFixed(2),
                product.quantity,
                product.expiryDate || 'N/A',
                product.available
            ]).draw(false);
        });
    }

    function clearTable() {
        productTable.clear().draw();
    }

    document.getElementById("addProductBtn").addEventListener("click", () => {
        document.getElementById("addProductFormContainer").style.display = "block";
    });

    document.getElementById("cancelAddProduct").addEventListener("click", () => {
        document.getElementById("addProductFormContainer").style.display = "none";
        document.getElementById("addProductForm").reset();
    });

    document.getElementById("addProductForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const form = e.target;
        const productData = {
            id: form.id.value.trim(),
            name: form.name.value.trim(),
            category: form.category.value,
            price: parseFloat(form.price.value),
            discount: parseFloat(form.discount.value),
            quantity: parseInt(form.quantity.value),
            expiryDate: form.expiryDate.value || null
        };

        try {
            const res = await fetch(`${baseUrl}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(productData)
            });

            if (!res.ok) throw new Error("Failed to add product");

            alert("Product added successfully!");
            form.reset();
            document.getElementById("addProductFormContainer").style.display = "none";
            loadProducts(baseUrl);
        } catch (error) {
            alert("Error adding product: " + error.message);
        }
    });

    document.getElementById("showReportBtn").addEventListener("click", async () => {
        try {
            const totalValueData = await fetchWithToken("http://localhost:8080/api/reports/total-value-by-category");
            const productsByCategoryData = await fetchWithToken("http://localhost:8080/api/reports/products-by-category");

            displayTotalValueByCategory(totalValueData);
            displayProductsByCategory(productsByCategoryData);
            document.getElementById("reportContainer").style.display = "block";
            document.getElementById("reportContainer").scrollIntoView({ behavior: "smooth" });
        } catch (error) {
            alert("Error loading reports");
            console.error(error);
        }
    });

    function displayTotalValueByCategory(data) {
        const ul = document.getElementById("totalValueByCategory");
        ul.innerHTML = '';
        for (const [category, total] of Object.entries(data)) {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.textContent = category;
            const span = document.createElement("span");
            span.className = "badge bg-primary rounded-pill";
            span.textContent = total.toFixed(2);
            li.appendChild(span);
            ul.appendChild(li);
        }
    }

    function displayProductsByCategory(data) {
        const container = document.getElementById("productsByCategory");
        container.innerHTML = '';
        for (const [category, products] of Object.entries(data)) {
            const div = document.createElement("div");
            div.className = "mb-4";
            div.innerHTML = `<h6>${category}</h6>`;
            const table = document.createElement("table");
            table.className = "table table-sm table-bordered";
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Price</th><th>Discount</th><th>Discounted Price</th><th>Quantity</th><th>Expiry Date</th><th>Available</th>
                    </tr>
                </thead><tbody></tbody>`;
            const tbody = table.querySelector("tbody");
            products.forEach(p => {
                const row = `<tr>
                    <td>${p.id}</td><td>${p.name}</td><td>${p.price.toFixed(2)}</td>
                    <td>${p.discount}%</td><td>${p.discountedPrice.toFixed(2)}</td>
                    <td>${p.quantity}</td><td>${p.expiryDate || "N/A"}</td><td>${p.available}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
            div.appendChild(table);
            container.appendChild(div);
        }
    }
</script>

</body>
</html>
